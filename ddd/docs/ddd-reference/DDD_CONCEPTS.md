# DDD 核心概念

本文档介绍 DDD 的基础理论。若需结合本项目看落地实践，请阅读 `DDD_GUIDE.md`。

## 什么是 DDD

领域驱动设计（DDD）是一种将业务知识与软件设计深度绑定的方法，目标是让代码模型准确表达业务概念。

主要收益：

- 代码与业务语义一致
- 高内聚、低耦合
- 业务规则集中，维护成本更低
- 领域逻辑可独立测试

## 核心术语

### 实体（Entity）

具有唯一标识的对象。即使属性一致，只要 ID 不同就是不同实体。

特征：

- 有业务唯一标识
- 生命周期中状态会变化
- 相等性由标识决定
- 持有业务行为

### 值对象（Value Object）

以属性描述、无身份标识的对象。属性完全相同即相等。

特征：

- 无唯一 ID
- 不可变（修改返回新实例）
- 按值比较
- 创建时自校验

示例：`Email`、`Money`、`Address`。

### 聚合根（Aggregate Root）

一组相关对象一致性边界的唯一入口。

规则：

1. 外部只能引用聚合根，不能直接引用内部实体。
2. 内部实体修改必须通过聚合根方法。
3. 单事务优先围绕单聚合执行。
4. 聚合之间通过 ID 关联。

### 领域服务（Domain Service）

承载不适合放入单个实体、且跨多个聚合的业务逻辑。

特征：

- 无状态
- 只读校验/计算，不直接 `Save()`
- 处理跨实体复杂规则

### 领域事件（Domain Event）

记录“已发生”的业务事实，用于模块解耦。

特征：

- 过去式命名
- 不可变
- 携带最小必要数据

### 仓储（Repository）

提供聚合根持久化抽象。

规则：

- 只持久化聚合根
- 提供领域语义接口
- 不暴露 SQL 细节
- 不负责事件发布（由 UoW 处理）

### 工作单元（Unit Of Work）

管理事务边界并协调一组操作的持久化。

职责：

- 开启/提交/回滚事务
- 收集聚合领域事件
- 按需写入 Outbox

## 分层架构

```text
表现层(api) -> 应用层(application) -> 领域层(domain) <- 基础设施层(infrastructure)
```

核心原则：领域层保持纯净，不依赖外部框架。

## 应用服务 vs 领域服务

- 应用服务：编排流程、管理事务、调用保存。
- 领域服务：表达规则、只读校验、不给持久化下指令。

判断方法：

1. 单实体规则：放实体方法。
2. 跨实体校验/计算：放领域服务。
3. 编排 + 持久化：放应用服务。

## 常见陷阱

1. 过度设计：简单 CRUD 场景不必强行 DDD。
2. 贫血模型：实体只有 getter/setter，规则全在 service。
3. 领域层依赖框架：引入数据库/HTTP 包。
4. 忽略聚合边界：外部直接改内部实体。
5. 领域服务做持久化：本质上混入了应用服务职责。
