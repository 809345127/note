# DDD 落地指南（项目版）

本指南聚焦“如何在本仓库中按 DDD 实施”，避免纯理论堆砌。

## 1. 依赖方向

必须遵循：`api -> application -> domain <- infrastructure`。

- `domain`：纯业务模型，不依赖 Gin/GORM。
- `application`：编排用例，负责事务边界与调用顺序。
- `infrastructure`：实现仓储、UoW、数据库访问。
- `api`：输入输出适配层。

## 2. 聚合与仓储

- 聚合根负责不变量和状态变更。
- 仓储只保存聚合根。
- 禁止控制器或应用层直接使用 `*gorm.DB`。

## 3. 应用服务职责

应用服务只做这三件事：

1. 参数与流程编排。
2. 调用领域服务/聚合行为。
3. 在 UoW 中提交持久化。

## 4. 事务与并发

- 使用 `UnitOfWorkFactory` 为每次请求创建新的 UoW。
- 通过 `version` 字段做乐观锁。
- 并发冲突映射为统一领域/应用错误码。

## 5. Outbox 策略

- 学习基线固定开启 outbox（无配置开关）。
- 开启后由 UoW 在同事务写入 outbox。
- 异步发布由 worker 负责，避免主流程耦合。

## 6. 表结构治理

- 生产环境不由应用管理 DDL。

## 7. Gin 层最佳实践

- 控制器保持薄：绑定参数 -> 调用 service -> 返回统一响应。
- 中间件顺序固定：request-id/recovery/logging/rate-limit/cors。
- 错误响应走统一结构与错误码。

## 8. GORM 层最佳实践

- 仓储方法统一接收 `context.Context`。
- 避免 N+1，批量查询后组装。
- 显式控制查询条件，避免条件泄漏到其他模型查询。

## 9. 最小可运行示例

见 `examples/minimal-service/`，可直接运行，不依赖 MySQL，适合作为团队新人入门和代码评审样板。

## 10. 评审建议

评审时优先看三件事：

1. 分层是否被破坏。
2. 事务边界与并发控制是否正确。
3. 错误模型和日志维度是否一致。
